<odoo>

    <!-- Record -->
    <record id="view_repair_order_form_custom" model="ir.ui.view">
        <field name="name">repair.order.form.custom</field>
        <field name="model">repair.order</field>
        <field name="inherit_id" ref="repair.view_repair_order_form" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="attributes">
                <attribute name="widget">statusbar</attribute>
                <attribute name="statusbar_visible">
                    draft,confirmed,under_repair,ready_for_deployment,done
                </attribute>
            </xpath>
        </field>
    </record>

    <!-- Record for Fields -->
    <record id="view_repair_order_form_custom_fields" model="ir.ui.view">
        <field name="name">repair.order.form.custom.fields</field>
        <field name="model">repair.order</field>
        <field name="inherit_id" ref="repair.view_repair_order_form" />
        <field name="arch" type="xml">

            <xpath expr="//field[@name='partner_id']" position="replace">
                <field name="partner_id" widget="selection"
                    readonly="1" />

                <field name="partner_id" widget="many2one_tags"
                    invisible="1" />
            </xpath>

            <xpath expr="//field[@name='product_id']" position="replace">
                <field name="product_id" widget="selection"
                    readonly="is_validated == False or state != 'draft' or not is_noc"
                    invisible="is_validated == True and state == 'draft' and is_noc" />

                <field name="product_id" widget="many2one_tags"
                    invisible="is_validated == False or state != 'draft' or not is_noc" />
            </xpath>

            <xpath expr="//field[@name='lot_id']" position="replace">
                <field name="lot_display" string="Lot/Serial Number"
                    readonly="is_validated == False or state != 'draft' or not is_noc"
                    invisible="is_validated == True and state == 'draft' and is_noc" />

                <field name="lot_id" invisible="1" />

                <field name="lot_id" widget="many2one_tags"
                    readonly="is_validated == False"
                    invisible="is_validated == False or state != 'draft' or not is_noc or tracking not in ['serial', 'lot']"
                    context="{'default_product_id': product_id}" />
            </xpath>

            <xpath expr="//field[@name='under_warranty']" position="before">
                    <field name="lot_ref"
                    invisible="tracking not in ['serial', 'lot']" />
            </xpath>

            <xpath expr="//field[@name='under_warranty']" position="attributes">
                <attribute name="readonly">not is_noc or state != 'draft'</attribute>
            </xpath>

            <xpath expr="//field[@name='parts_availability']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='schedule_date']" position="attributes">
                <attribute name="readonly">1</attribute>
            </xpath>

            <xpath expr="//field[@name='tag_ids']" position="attributes">
                <attribute name="readonly">not is_inventory_admin or not is_validated</attribute>
                <attribute name="options">{'no_create_edit': True}</attribute>
            </xpath>

            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='company_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//field[@name='picking_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//div[hasclass('o_row')]" position="replace">
            </xpath>

            <xpath expr="//label[@for='product_qty']" position="replace">
            </xpath>

        </field>

    </record>

    <!-- Record for buttons -->
    <record id="view_repair_order_form_custom_buttons" model="ir.ui.view">
        <field name="name">repair.order.form.custom.buttons</field>
        <field name="model">repair.order</field>
        <field name="inherit_id" ref="repair.view_repair_order_form" />
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_unreserve']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//button[@name='action_repair_cancel']" position="replace"/>

            <xpath expr="//button[@name='action_create_sale_order']" position="replace"/>

            <xpath expr="//button[@name='action_view_sale_order']" position="attributes">
                <attribute name="invisible">state != 'under_repair' or is_mining or not sale_order_id</attribute>
            </xpath>

            <xpath expr="//button[@name='action_repair_end']" position="replace">
            </xpath>

            <xpath expr="//button[@name='action_assign']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//header/button[@name='action_validate']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//header/button[@name='action_repair_start']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//header/button[@name='action_repair_end']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>

            <xpath expr="//header" position="inside">
                <button name="action_repair_cancel"
                    type="object"
                    string="Cancel Repair"
                    class="btn-secondary"
                    invisible="state in ['done', 'draft', 'cancel', 'ready_for_deployment'] or scrapped or 'pending to receive' in tag_names"
                    groups="pisa_repair.group_noc,pisa_repair.group_micro"
                    confirm="Are you sure you want to cancel this repair?" />

                <button name="action_mark_not_received"
                    type="object"
                    string="Not Received"
                    class="btn-secondary"
                    confirm="This will remove 'Pending to Receive' and set 'Not Received'. Responsibility returns to Mining. Continue?"
                    invisible="state != 'confirmed' or not is_micro or 'pending to receive' not in tag_names"/>

                <button name="action_create_sale_order"
                    type="object"
                    string="Create Quotation"
                    class="btn-primary"
                    invisible="scrapped or is_validated == False or state != 'under_repair' or sale_order_id or not tag_names or 'under diagnosis' not in tag_names"
                    groups="pisa_repair.group_noc,pisa_repair.group_micro"/>
                <button name="action_open_validation_wizard"
                    type="object"
                    string="Validate"
                    class="btn-primary"
                    invisible="is_validated or 
                        (is_noc) or
                        (under_warranty and (is_noc)) or
                        (is_mining and state == 'under_repair' and not (state == 'under_repair' and under_warranty)) or
                        (not is_mining and state == 'draft') or
                        (is_micro and state != 'under_repair' and 'pending to receive' not in tag_names)" />
                <button name="action_next_state"
                    type="object"
                    string="Next Stage"
                    class="btn-primary"
                    invisible="(not is_validated or 
                        state in ('done', 'cancel') or
                        (is_noc) or 
                        (under_warranty and not is_mining) or
                        (is_mining and state == 'under_repair' and not (state == 'under_repair' and under_warranty)) or
                        (is_micro and state != 'under_repair') or
                        ((not tag_names or
                        'pending of diagnosis' in tag_names or
                        'under diagnosis' in tag_names or
                        ('under repair' not in tag_names and not under_warranty)) and state == 'under_repair'))
                        or (scrapped and state == 'under_repair') or (not extraction and state == 'confirmed')
                        or (is_micro and state == 'under_repair' and not is_testing_passed)
                        or (extraction and state == 'confirmed' and 'pending to receive' not in tag_names)
                        or (state == 'confirmed' and 'pending to receive' in tag_names and not is_micro)"/>

                    <button name="action_next_state"
                    type="object"
                    string="Next Stage"
                    class="btn-primary"
                    invisible="state != 'confirmed' or not is_validated or extraction"
                    confirm="You have not marked 'Extraction Will Be Necessary'. If you continue, the order will go directly to 'Done'."/>


                    <button name="action_next_state"
                    type="object"
                    string="Next Stage"
                    class="btn-primary"
                    invisible="state != 'under_repair' or not is_validated or not scrapped or 'under_diagnosis' in tag_names or (is_micro and state == 'under_repair' and not is_testing_passed)"
                    confirm="If the product is marked as scrapped, the order will be directly set to 'Done'. Do you want to proceed?"/>

                    <button name="action_mark_pending_to_receive"
                        type="object"
                        string="Send to Micro"
                        class="btn-primary"
                        invisible="not is_validated or state != 'confirmed' or not extraction or 'pending to receive' in tag_names"/>

                    <button name="action_next_state"
                        type="object"
                        string="Next Stage"
                        class="btn-primary"
                        confirm="This will mark the unit as 'Received' and move to the next stage. Continue?"
                        invisible="not is_validated or state != 'confirmed' or not is_micro or 'pending to receive' not in tag_names"/>
            </xpath>


            <xpath expr="//field[@name='under_warranty']" position="after">
                    <button name="action_start_diagnosis"
                            type="object"
                            string="Start Diagnosis"
                            class="btn-primary"
                            invisible="not is_validated or 
                                (not is_micro or state != 'under_repair') or 
                                sale_order_id or
                                ('pending of diagnosis' not in tag_names and tag_names)"
                            />

                    <button name="action_start_repair"
                            type="object"
                            string="Start Repair"
                            class="btn-primary"
                            invisible="not is_validated or 
                            (not is_micro or state != 'under_repair') or 
                            ((not tag_names or 'quotation created' not in tag_names) and not sale_order_id) or
                            'under repair' in tag_names or 
                            'testing' in tag_names or
                            'testing passed' in tag_names"
                            />

                    <button name="action_start_testing"
                            type="object"
                            string="Start Testing"
                            class="btn-primary"
                            invisible="not is_validated or
                            (not is_micro or state != 'under_repair') or 
                            not is_in_repair or is_in_testing or 
                            'testing passed' in tag_names"
                            />

                    <button name="action_finish_testing"
                            type="object"
                            string="Finish Testing"
                            class="btn-success"
                            invisible="not is_validated or 
                            (not is_micro or state != 'under_repair') or 
                            not is_in_testing"
                            />

                    <button name="action_back_to_under_diagnosis"
                            type="object"
                            string="Back to Under Diagnosis"
                            class="btn-secondary"
                            invisible="not is_validated or 
                            (not is_micro or state != 'under_repair') or 
                            not is_in_testing"
                            />
            </xpath>

           

            <xpath expr="//header/button[@name='action_repair_cancel_draft']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
        </field>
    </record>

</odoo>
